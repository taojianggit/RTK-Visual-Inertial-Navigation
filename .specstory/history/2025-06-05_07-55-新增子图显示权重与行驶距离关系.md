<!-- Generated by SpecStory -->

# 新增子图显示权重与行驶距离关系 (2025-06-05 15:55:25)

_**User**_

参照analyzeReprojectionError.py，新增子图画出权重随行驶距离的变化曲线

---

_**Assistant**_



---

我需要先查看`analyzeReprojectionError.py`文件来了解参考的实现方式，然后在当前文件中添加权重随行驶距离变化的子图。

---

<details>
            <summary>Searched codebase "analyzeReprojectionError.py" • **3** results</summary>
        
| File |
|------|
| `undefined` |
| `undefined` |
| `undefined` |

</details>

---

Read file: evaluate/reprojection_error/analyzeReprojectionError.py

---

让我继续查看文件中关于权重绘图的部分：

---

<details>
            <summary>Grep search for "权重随行驶距离" • **3** files</summary>
        
| File | Line | Match |
|------|------|-------|
| `file:///home/lenovo/catkin_ws_debug2/src/RTK-Visual-Inertial-Navigation/test_weight_visualization.py` | L5 | `验证新增的权重随行驶距离变化子图` |
| `file:///home/lenovo/catkin_ws_debug2/src/RTK-Visual-Inertial-Navigation/test_weight_visualization.py` | L81 | `# 子图2：权重随行驶距离变化` |
| `file:///home/lenovo/catkin_ws_debug2/src/RTK-Visual-Inertial-Navigation/evaluate/reprojection_error/analyzeReprojectionError.py` | L314 | `# 第六个子图：重投影误差权重随行驶距离变化（如果有加权数据，过滤权重>2.0）` |
| `file:///home/lenovo/catkin_ws_debug2/src/RTK-Visual-Inertial-Navigation/evaluate/reprojection_error/analyzeReprojectionError.py` | L792 | `# 子图7：重投影误差权重随行驶距离变化` |
| `file:///home/lenovo/catkin_ws_debug2/src/RTK-Visual-Inertial-Navigation/evaluate/imu_residual/analyzeReprojectionError.py` | L307 | `# 第六个子图：重投影误差权重随行驶距离变化（如果有加权数据，过滤权重>2.0）` |
| `file:///home/lenovo/catkin_ws_debug2/src/RTK-Visual-Inertial-Navigation/evaluate/imu_residual/analyzeReprojectionError.py` | L785 | `# 子图7：重投影误差权重随行驶距离变化` |

</details>

---

现在让我查看参考文件中权重随行驶距离变化的具体实现：

---

Read file: evaluate/reprojection_error/analyzeReprojectionError.py

---

现在我了解了参考实现。我需要在当前的`analyzeIMUPositionResidual.py`文件中添加一个类似的权重随行驶距离变化的子图。根据参考代码，我需要在第五个子图之后（或者在合适的位置）添加这个新的子图。

---

```diff
                      print(f"No additional data plot saved as {t_name}_{label}_no_additional_data.png")
          plt.show()
- 
+         
+         # 第六个子图：IMU位置残差权重随行驶距离变化（如果有加权数据，过滤权重>weight_threshold）
+         plt.figure(figsize=(10, 6))
+         if 'weighted_imu_pos_res_norm' in residual_df.columns:
+             # 计算权重 = 加权误差 / 原始误差 (避免除零)
+             weights = np.divide(residual_df['weighted_imu_pos_res_norm'], residual_df['imu_pos_res_norm'], 
+                               out=np.ones_like(residual_df['imu_pos_res_norm']), 
+                               where=residual_df['imu_pos_res_norm'] != 0)
+             
+             # 注意：由于在数据收集阶段已经过滤了权重>weight_threshold的数据点，这里的权重应该都<=weight_threshold
+             plt.plot(residual_df['travel_distance'], weights, alpha=0.8, color='darkorange', linewidth=1.5)
+             plt.xlabel('Travel Distance (m)')
+             plt.ylabel('IMU Position Residual Weight (Weighted/Raw)')
+             plt.title(f'IMU Position Residual Weight vs Travel Distance (Filtered ≤{weight_threshold}) - {t_name}')
+             plt.grid(True, alpha=0.3)
+             
+             # 添加水平参考线 (权重=1表示没有加权调整)
+             plt.axhline(y=1.0, color='gray', linestyle='--', alpha=0.8, label='No Weight (Weight=1)')
+             plt.axhline(y=weight_threshold, color='red', linestyle=':', alpha=0.8, label=f'Weight Threshold ({weight_threshold})')
+             
+             # 计算并显示权重统计信息
+             weight_mean = np.mean(weights)
+             weight_std = np.std(weights)
+             weight_max = np.max(weights)
+             weight_min = np.min(weights)
+             stats_text = f'Weight (Filtered): μ={weight_mean:.3f}, σ={weight_std:.3f}, min={weight_min:.3f}, max={weight_max:.3f}'
+             plt.text(0.02, 0.98, stats_text, transform=plt.gca().transAxes, 
+                     verticalalignment='top', bbox=dict(boxstyle='round', facecolor='lightgreen', alpha=0.8))
+             
+             plt.legend()
+             if save_residual:
+                 plt.savefig(f"{t_name}_{label}_imu_pos_res_weight_vs_distance_filtered.png", dpi=300, bbox_inches='tight')
+                 print(f"Filtered IMU position residual weight vs distance plot saved as {t_name}_{label}_imu_pos_res_weight_vs_distance_filtered.png")
+         else:
+             plt.text(0.5, 0.5, 'No Weighted IMU Position Residual Data Available', ha='center', va='center', 
+                     transform=plt.gca().transAxes, fontsize=14, color='gray')
+             plt.xlabel('Travel Distance (m)')
+             plt.ylabel('IMU Position Residual Weight')
+             plt.title(f'IMU Position Residual Weight vs Travel Distance - {t_name}')
+             plt.grid(True, alpha=0.3)
+             if save_residual:
+                 plt.savefig(f"{t_name}_{label}_no_weight_data.png", dpi=300, bbox_inches='tight')
+                 print(f"No weight data plot saved as {t_name}_{label}_no_weight_data.png")
+         plt.show()
+ 
      # 保存同步的残差和误差数据
      if save_residual and matched_residuals:
```

---

现在我还需要更新文件末尾的输出信息，以反映新增的第六个子图：

---

Read file: evaluate/imu_residual/analyzeIMUPositionResidual.py

---

现在我需要更新文件末尾的输出信息，增加新的第六个子图：

---

```diff
      print("\n=== Analysis Complete ===")
      print("Output files generated:")
-     print("Analysis plots (5 individual plots):")
+     print("Analysis plots (6 individual plots):")
      print("1. R1M1_Proposed_position_error_components.png - Position error components")
      print("2. R1M1_Proposed_imu_pos_res_components.png - IMU position residual components")
      print("3. R1M1_Proposed_norm_comparison.png - Position vs IMU position residual norm comparison")
      print("4. R1M1_Proposed_scaled_comparison.png - Position error vs IMU position residual × 10 comparison")
      print("5. R1M1_Proposed_raw_vs_weighted_imu_pos.png - Raw vs weighted IMU position residual (if available)")
+     print("6. R1M1_Proposed_imu_pos_res_weight_vs_distance_filtered.png - IMU position residual weight vs travel distance (if available)")
      print("Distribution analysis plots (7 individual plots):")
-     print("6. imu_pos_res_norm_distribution.png - IMU position residual norm distribution")
-     print("7. imu_pos_res_x_distribution.png - IMU position residual X component distribution")
-     print("8. imu_pos_res_y_distribution.png - IMU position residual Y component distribution")
-     print("9. imu_pos_res_z_distribution.png - IMU position residual Z component distribution")
-     print("10. position_vs_imu_pos_res_scatter.png - Position vs IMU position residual scatter plot")
-     print("11. imu_pos_res_vs_travel_distance.png - IMU position residual vs travel distance")
-     print("12. raw_vs_weighted_imu_pos_res_scatter.png - Raw vs weighted IMU position residual scatter (if available)")
+     print("7. imu_pos_res_norm_distribution.png - IMU position residual norm distribution")
+     print("8. imu_pos_res_x_distribution.png - IMU position residual X component distribution")
+     print("9. imu_pos_res_y_distribution.png - IMU position residual Y component distribution")
+     print("10. imu_pos_res_z_distribution.png - IMU position residual Z component distribution")
+     print("11. position_vs_imu_pos_res_scatter.png - Position vs IMU position residual scatter plot")
+     print("12. imu_pos_res_vs_travel_distance.png - IMU position residual vs travel distance")
+     print("13. raw_vs_weighted_imu_pos_res_scatter.png - Raw vs weighted IMU position residual scatter (if available)")
      print("Data files:")
-     print("13. R1M1_Proposed_synchronized_imu_pos_res_analysis.csv - Synchronized data")
-     print("14. R1M1_Proposed_imu_pos_res_statistics.csv - Statistical analysis") 
+     print("14. R1M1_Proposed_synchronized_imu_pos_res_analysis.csv - Synchronized data")
+     print("15. R1M1_Proposed_imu_pos_res_statistics.csv - Statistical analysis") 
```

---

完成了！我已经成功地参照`analyzeReprojectionError.py`的实现方式，在`analyzeIMUPositionResidual.py`文件中新增了第六个子图，用于画出IMU位置残差权重随行驶距离的变化曲线。

## 新增的主要功能包括：

1. **第六个子图：IMU位置残差权重随行驶距离变化**
   - 计算权重：权重 = 加权IMU位置残差 / 原始IMU位置残差
   - 绘制权重随行驶距离的变化曲线
   - 添加水平参考线：权重=1（表示没有加权调整）和权重阈值线
   - 显示权重统计信息（均值、标准差、最小值、最大值）
   - 只有在存在加权数据时才绘制，否则显示"无加权数据可用"的提示

2. **参考实现的特点：**
   - 使用了与参考文件相同的权重计算方法，避免除零错误
   - 采用相同的颜色方案（darkorange）和线条样式
   - 添加了相同的统计信息显示框和参考线
   - 保持了与原有代码风格的一致性

3. **更新了输出信息：**
   - 将分析图从5个更新为6个
   - 重新编号了所有输出文件
   - 新增的图片文件名：`R1M1_Proposed_imu_pos_res_weight_vs_distance_filtered.png`

这个新增的子图可以帮助分析IMU位置残差的权重分布情况，观察权重随行驶距离的变化趋势，了解加权算法在不同阶段的行为特征。

---

_**User**_

在第4个子图的基础上新增一个子图，同时画出imu位置残差权重缩小1000000倍

---

_**Assistant**_



---

我需要先查看第4个子图的完整代码，然后在其基础上新增一个子图。

---

Read file: evaluate/imu_residual/analyzeIMUPositionResidual.py

---

现在我需要在第4个子图后面新增一个子图，包含第4个子图的内容，同时加上IMU位置残差权重缩小1000000倍。我会在第4个子图之后，第5个子图之前插入新的子图：

---

```diff
              print(f"Scaled comparison plot saved as {t_name}_{label}_scaled_comparison.png")
          plt.show()
+         
+         # 第4.5个子图：综合对比 - 位置误差、IMU位置残差×10、IMU位置残差权重÷1000000
+         plt.figure(figsize=(12, 6))
+         # 始终显示位置误差和IMU位置残差×10
+         imu_residual_norm_scaled = residual_df['imu_pos_res_norm'] * 10  # 放大10倍
+         plt.plot(residual_df['travel_distance'], residual_df['position_error_norm'], 
+                 label=f"Position Error Norm - {label}", alpha=0.8, linewidth=2, color='blue')
+         plt.plot(residual_df['travel_distance'], imu_residual_norm_scaled, 
+                 label=f"IMU Pos Residual Norm × 10 - {label}", alpha=0.8, linewidth=2, color='red')
+         
+         # 只有在有加权数据时才显示权重÷1000000
+         if 'weighted_imu_pos_res_norm' in residual_df.columns:
+             # 计算权重 = 加权误差 / 原始误差，然后缩小1000000倍
+             weights = np.divide(residual_df['weighted_imu_pos_res_norm'], residual_df['imu_pos_res_norm'], 
+                               out=np.ones_like(residual_df['imu_pos_res_norm']), 
+                               where=residual_df['imu_pos_res_norm'] != 0)
+             weight_scaled = weights / 1000000  # 缩小1000000倍
+             plt.plot(residual_df['travel_distance'], weight_scaled, 
+                     label=f"IMU Pos Residual Weight ÷ 1,000,000 - {label}", alpha=0.8, linewidth=2, color='orange')
+             plot_title = f'Comprehensive Comparison: Position Error vs IMU Residual × 10 vs Weight ÷ 1,000,000 - {t_name}'
+             
+             # 计算相关性
+             correlation_position_imu = np.corrcoef(residual_df['position_error_norm'], imu_residual_norm_scaled)[0,1]
+             correlation_position_weight = np.corrcoef(residual_df['position_error_norm'], weight_scaled)[0,1]
+             correlation_imu_weight = np.corrcoef(imu_residual_norm_scaled, weight_scaled)[0,1]
+             
+             # 添加相关性信息
+             corr_text = f'Correlations:\nPos-IMU×10: {correlation_position_imu:.4f}\nPos-Weight÷1M: {correlation_position_weight:.4f}\nIMU×10-Weight÷1M: {correlation_imu_weight:.4f}'
+             plt.text(0.02, 0.98, corr_text, transform=plt.gca().transAxes, 
+                     verticalalignment='top', bbox=dict(boxstyle='round', facecolor='lightcyan', alpha=0.8))
+             
+             # 添加平均值信息
+             avg_position = np.mean(residual_df['position_error_norm'])
+             avg_imu_scaled = np.mean(imu_residual_norm_scaled)
+             avg_weight_scaled = np.mean(weight_scaled)
+             avg_text = f'Averages:\nPosition: {avg_position:.4f}\nIMU×10: {avg_imu_scaled:.6f}\nWeight÷1M: {avg_weight_scaled:.9f}'
+             plt.text(0.98, 0.98, avg_text, transform=plt.gca().transAxes, 
+                     verticalalignment='top', horizontalalignment='right',
+                     bbox=dict(boxstyle='round', facecolor='lightgreen', alpha=0.8))
+         else:
+             plot_title = f'Comparison: Position Error vs IMU Position Residual × 10 - {t_name}'
+             # 只有两条线时的相关性
+             correlation_position_imu = np.corrcoef(residual_df['position_error_norm'], imu_residual_norm_scaled)[0,1]
+             plt.text(0.02, 0.98, f'Position-IMU×10 Correlation: {correlation_position_imu:.4f}', 
+                     transform=plt.gca().transAxes, verticalalignment='top', 
+                     bbox=dict(boxstyle='round', facecolor='lightcyan', alpha=0.8))
+             
+             # 平均值信息
+             avg_position = np.mean(residual_df['position_error_norm'])
+             avg_imu_scaled = np.mean(imu_residual_norm_scaled)
+             avg_text = f'Averages:\nPosition: {avg_position:.4f}\nIMU×10: {avg_imu_scaled:.6f}'
+             plt.text(0.98, 0.98, avg_text, transform=plt.gca().transAxes, 
+                     verticalalignment='top', horizontalalignment='right',
+                     bbox=dict(boxstyle='round', facecolor='lightgreen', alpha=0.8))
+         
+         plt.xlabel('Travel Distance (m)')
+         plt.ylabel('Error Value')
+         plt.title(plot_title)
+         plt.legend(bbox_to_anchor=(0.5, 1.15), loc='upper center', ncol=2)
+         plt.grid(True, alpha=0.3)
+         
+         if save_residual:
+             plt.savefig(f"{t_name}_{label}_comprehensive_comparison_with_weight.png", dpi=300, bbox_inches='tight')
+             print(f"Comprehensive comparison with weight plot saved as {t_name}_{label}_comprehensive_comparison_with_weight.png")
+         plt.show()
          
          # 第五个子图：如果有加权IMU位置残差，则对比原始和加权
```

---

现在我需要更新文件末尾的输出信息，以反映新增的第4.5个子图：

---

Read file: evaluate/imu_residual/analyzeIMUPositionResidual.py

---

现在我需要更新文件末尾的输出信息，将分析图从6个更新为7个（包括新增的第4.5个子图）：

---

```diff
      print("\n=== Analysis Complete ===")
      print("Output files generated:")
-     print("Analysis plots (6 individual plots):")
+     print("Analysis plots (7 individual plots):")
      print("1. R1M1_Proposed_position_error_components.png - Position error components")
      print("2. R1M1_Proposed_imu_pos_res_components.png - IMU position residual components")
      print("3. R1M1_Proposed_norm_comparison.png - Position vs IMU position residual norm comparison")
      print("4. R1M1_Proposed_scaled_comparison.png - Position error vs IMU position residual × 10 comparison")
-     print("5. R1M1_Proposed_raw_vs_weighted_imu_pos.png - Raw vs weighted IMU position residual (if available)")
-     print("6. R1M1_Proposed_imu_pos_res_weight_vs_distance_filtered.png - IMU position residual weight vs travel distance (if available)")
+     print("5. R1M1_Proposed_comprehensive_comparison_with_weight.png - Comprehensive comparison with weight ÷ 1,000,000 (if available)")
+     print("6. R1M1_Proposed_raw_vs_weighted_imu_pos.png - Raw vs weighted IMU position residual (if available)")
+     print("7. R1M1_Proposed_imu_pos_res_weight_vs_distance_filtered.png - IMU position residual weight vs travel distance (if available)")
      print("Distribution analysis plots (7 individual plots):")
-     print("7. imu_pos_res_norm_distribution.png - IMU position residual norm distribution")
-     print("8. imu_pos_res_x_distribution.png - IMU position residual X component distribution")
-     print("9. imu_pos_res_y_distribution.png - IMU position residual Y component distribution")
-     print("10. imu_pos_res_z_distribution.png - IMU position residual Z component distribution")
-     print("11. position_vs_imu_pos_res_scatter.png - Position vs IMU position residual scatter plot")
-     print("12. imu_pos_res_vs_travel_distance.png - IMU position residual vs travel distance")
-     print("13. raw_vs_weighted_imu_pos_res_scatter.png - Raw vs weighted IMU position residual scatter (if available)")
+     print("8. imu_pos_res_norm_distribution.png - IMU position residual norm distribution")
+     print("9. imu_pos_res_x_distribution.png - IMU position residual X component distribution")
+     print("10. imu_pos_res_y_distribution.png - IMU position residual Y component distribution")
+     print("11. imu_pos_res_z_distribution.png - IMU position residual Z component distribution")
+     print("12. position_vs_imu_pos_res_scatter.png - Position vs IMU position residual scatter plot")
+     print("13. imu_pos_res_vs_travel_distance.png - IMU position residual vs travel distance")
+     print("14. raw_vs_weighted_imu_pos_res_scatter.png - Raw vs weighted IMU position residual scatter (if available)")
      print("Data files:")
-     print("14. R1M1_Proposed_synchronized_imu_pos_res_analysis.csv - Synchronized data")
-     print("15. R1M1_Proposed_imu_pos_res_statistics.csv - Statistical analysis") 
+     print("15. R1M1_Proposed_synchronized_imu_pos_res_analysis.csv - Synchronized data")
+     print("16. R1M1_Proposed_imu_pos_res_statistics.csv - Statistical analysis") 
```

---

完成了！我已经成功地在第4个子图的基础上新增了一个综合对比子图（第4.5个子图），该子图包含：

## 新增的第4.5个子图功能：

1. **三条曲线同时显示：**
   - **位置误差范数**（蓝色线）
   - **IMU位置残差范数×10**（红色线）
   - **IMU位置残差权重÷1,000,000**（橙色线，只有在存在加权数据时显示）

2. **统计信息显示：**
   - **相关性分析：** 计算三条曲线之间的两两相关性
     - 位置误差 vs IMU残差×10
     - 位置误差 vs 权重÷1,000,000  
     - IMU残差×10 vs 权重÷1,000,000
   - **平均值信息：** 显示三条曲线的平均值

3. **图表特性：**
   - 使用更大的图表尺寸（12×6）以容纳更多信息
   - 图例放置在图表上方中央位置，避免遮挡数据
   - 统计信息分别显示在左上角（相关性）和右上角（平均值）
   - 保存为独立的PNG文件：`R1M1_Proposed_comprehensive_comparison_with_weight.png`

4. **智能显示：**
   - 如果没有加权数据，只显示两条曲线（位置误差和IMU残差×10）
   - 对应的统计信息也会相应调整

这个综合对比子图可以帮助分析：
- 位置误差与IMU位置残差的数量级关系（通过×10缩放）
- 权重变化与位置误差、IMU残差的相关性
- 三种指标随行驶距离的变化趋势和相互关系

总共现在有7个分析子图和7个分布分析子图，文件输出信息也已经相应更新。

---

_**User**_

在第四个子图的基础上新增一个子图，只分析950m以后的数据

---

_**Assistant**_



---

我需要在第四个子图的基础上新增一个子图，只分析950m以后的数据。我会在第四个子图之后、第4.5个子图之前插入这个新的子图。

---

```diff
          plt.show()
          
-         # 第四个子图：IMU位置残差放大10倍和位置误差的对比
+         # 第四个子图：IMU位置残差放大100倍和位置误差的对比
          plt.figure(figsize=(10, 6))
-         imu_residual_norm_scaled = residual_df['imu_pos_res_norm'] * 100  # 放大10倍
+         imu_residual_norm_scaled = residual_df['imu_pos_res_norm'] * 100  # 放大100倍
          plt.plot(residual_df['travel_distance'], residual_df['position_error_norm'], 
                  label=f"Position Error Norm - {label}", alpha=0.8, linewidth=2, color='blue')
          plt.plot(residual_df['travel_distance'], imu_residual_norm_scaled, 
-                 label=f"IMU Pos Residual Norm × 10 - {label}", alpha=0.8, linewidth=2, color='red')
+                 label=f"IMU Pos Residual Norm × 100 - {label}", alpha=0.8, linewidth=2, color='red')
          plt.xlabel('Travel Distance (m)')
          plt.ylabel('Error Value (m)')
-         plt.title(f'Scaled Comparison: Position Error vs IMU Position Residual × 10 - {t_name}')
+         plt.title(f'Scaled Comparison: Position Error vs IMU Position Residual × 100 - {t_name}')
          plt.legend()
          plt.grid(True, alpha=0.3)
```

```diff
          avg_position = np.mean(residual_df['position_error_norm'])
          avg_imu_scaled = np.mean(imu_residual_norm_scaled)
-         ratio_text = f'Correlation: {correlation_scaled:.4f}\nAvg Position: {avg_position:.4f}\nAvg IMU×10: {avg_imu_scaled:.6f}\nRatio: {avg_position/avg_imu_scaled:.3f}'
+         ratio_text = f'Correlation: {correlation_scaled:.4f}\nAvg Position: {avg_position:.4f}\nAvg IMU×100: {avg_imu_scaled:.6f}\nRatio: {avg_position/avg_imu_scaled:.3f}'
          plt.text(0.02, 0.98, ratio_text, transform=plt.gca().transAxes, 
                  verticalalignment='top', bbox=dict(boxstyle='round', facecolor='lightcyan', alpha=0.8))
```

```diff
              print(f"Scaled comparison plot saved as {t_name}_{label}_scaled_comparison.png")
          plt.show()
+         
+         # 第4.1个子图：IMU位置残差放大100倍和位置误差的对比（只分析950m以后的数据）
+         plt.figure(figsize=(10, 6))
+         # 过滤950m以后的数据
+         mask_950m = residual_df['travel_distance'] > 950
+         if np.any(mask_950m):
+             filtered_df = residual_df[mask_950m]
+             imu_residual_norm_scaled_950 = filtered_df['imu_pos_res_norm'] * 100  # 放大100倍
+             
+             plt.plot(filtered_df['travel_distance'], filtered_df['position_error_norm'], 
+                     label=f"Position Error Norm - {label}", alpha=0.8, linewidth=2, color='blue')
+             plt.plot(filtered_df['travel_distance'], imu_residual_norm_scaled_950, 
+                     label=f"IMU Pos Residual Norm × 100 - {label}", alpha=0.8, linewidth=2, color='red')
+             plt.xlabel('Travel Distance (m)')
+             plt.ylabel('Error Value (m)')
+             plt.title(f'Scaled Comparison (>950m): Position Error vs IMU Position Residual × 100 - {t_name}')
+             plt.legend()
+             plt.grid(True, alpha=0.3)
+             
+             # 添加相关性信息到图中（只针对950m以后的数据）
+             correlation_scaled_950 = np.corrcoef(filtered_df['position_error_norm'], imu_residual_norm_scaled_950)[0,1]
+             # 计算比例信息
+             avg_position_950 = np.mean(filtered_df['position_error_norm'])
+             avg_imu_scaled_950 = np.mean(imu_residual_norm_scaled_950)
+             data_count_950 = len(filtered_df)
+             total_data_count = len(residual_df)
+             percentage_950 = (data_count_950 / total_data_count) * 100
+             
+             ratio_text_950 = f'Data >950m: {data_count_950}/{total_data_count} ({percentage_950:.1f}%)\nCorrelation: {correlation_scaled_950:.4f}\nAvg Position: {avg_position_950:.4f}\nAvg IMU×100: {avg_imu_scaled_950:.6f}\nRatio: {avg_position_950/avg_imu_scaled_950:.3f}'
+             plt.text(0.02, 0.98, ratio_text_950, transform=plt.gca().transAxes, 
+                     verticalalignment='top', bbox=dict(boxstyle='round', facecolor='lightcyan', alpha=0.8))
+             
+             if save_residual:
+                 plt.savefig(f"{t_name}_{label}_scaled_comparison_950m_plus.png", dpi=300, bbox_inches='tight')
+                 print(f"Scaled comparison (>950m) plot saved as {t_name}_{label}_scaled_comparison_950m_plus.png")
+         else:
+             plt.text(0.5, 0.5, 'No Data Available for Travel Distance > 950m', ha='center', va='center', 
+                     transform=plt.gca().transAxes, fontsize=14, color='gray')
+             plt.xlabel('Travel Distance (m)')
+             plt.ylabel('Error Value (m)')
+             plt.title(f'Scaled Comparison (>950m): No Data Available - {t_name}')
+             plt.grid(True, alpha=0.3)
+             if save_residual:
+                 plt.savefig(f"{t_name}_{label}_no_data_950m_plus.png", dpi=300, bbox_inches='tight')
+                 print(f"No data >950m plot saved as {t_name}_{label}_no_data_950m_plus.png")
+         plt.show()
          
          # 第4.5个子图：综合对比 - 位置误差、IMU位置残差×10、IMU位置残差权重÷1000000
```

---

我还需要检查并修正第4.5个子图的标题和标签，以反映用户对缩放因子的修改（从×10改为×100，权重缩放也有变化）：

---

Read file: evaluate/imu_residual/analyzeIMUPositionResidual.py

---

我需要修正第4.5个子图中的标题和标签，以反映正确的缩放因子（×100而不是×10，权重÷10000而不是÷1000000）：

---

```diff
          plt.show()
          
-         # 第4.5个子图：综合对比 - 位置误差、IMU位置残差×10、IMU位置残差权重÷1000000
+         # 第4.5个子图：综合对比 - 位置误差、IMU位置残差×100、IMU位置残差权重÷10000
          plt.figure(figsize=(12, 6))
-         # 始终显示位置误差和IMU位置残差×10
-         imu_residual_norm_scaled = residual_df['imu_pos_res_norm'] * 100  # 放大10倍
+         # 始终显示位置误差和IMU位置残差×100
+         imu_residual_norm_scaled = residual_df['imu_pos_res_norm'] * 100  # 放大100倍
          plt.plot(residual_df['travel_distance'], residual_df['position_error_norm'], 
                  label=f"Position Error Norm - {label}", alpha=0.8, linewidth=2, color='blue')
          plt.plot(residual_df['travel_distance'], imu_residual_norm_scaled, 
-                 label=f"IMU Pos Residual Norm × 10 - {label}", alpha=0.8, linewidth=2, color='red')
+                 label=f"IMU Pos Residual Norm × 100 - {label}", alpha=0.8, linewidth=2, color='red')
          
-         # 只有在有加权数据时才显示权重÷1000000
+         # 只有在有加权数据时才显示权重÷10000
          if 'weighted_imu_pos_res_norm' in residual_df.columns:
-             # 计算权重 = 加权误差 / 原始误差，然后缩小1000000倍
+             # 计算权重 = 加权误差 / 原始误差，然后缩小10000倍
              weights = np.divide(residual_df['weighted_imu_pos_res_norm'], residual_df['imu_pos_res_norm'], 
                                out=np.ones_like(residual_df['imu_pos_res_norm']), 
                                where=residual_df['imu_pos_res_norm'] != 0)
-             weight_scaled = weights / 10000  # 缩小1000000倍
+             weight_scaled = weights / 10000  # 缩小10000倍
              plt.plot(residual_df['travel_distance'], weight_scaled, 
-                     label=f"IMU Pos Residual Weight ÷ 1,000,000 - {label}", alpha=0.8, linewidth=2, color='orange')
-             plot_title = f'Comprehensive Comparison: Position Error vs IMU Residual × 10 vs Weight ÷ 1,000,000 - {t_name}'
+                     label=f"IMU Pos Residual Weight ÷ 10,000 - {label}", alpha=0.8, linewidth=2, color='orange')
+             plot_title = f'Comprehensive Comparison: Position Error vs IMU Residual × 100 vs Weight ÷ 10,000 - {t_name}'
              
              # 计算相关性
```

```diff
              
              # 添加相关性信息
-             corr_text = f'Correlations:\nPos-IMU×10: {correlation_position_imu:.4f}\nPos-Weight÷1M: {correlation_position_weight:.4f}\nIMU×10-Weight÷1M: {correlation_imu_weight:.4f}'
+             corr_text = f'Correlations:\nPos-IMU×100: {correlation_position_imu:.4f}\nPos-Weight÷10K: {correlation_position_weight:.4f}\nIMU×100-Weight÷10K: {correlation_imu_weight:.4f}'
              plt.text(0.02, 0.98, corr_text, transform=plt.gca().transAxes, 
                      verticalalignment='top', bbox=dict(boxstyle='round', facecolor='lightcyan', alpha=0.8))
```

```diff
              avg_imu_scaled = np.mean(imu_residual_norm_scaled)
              avg_weight_scaled = np.mean(weight_scaled)
-             avg_text = f'Averages:\nPosition: {avg_position:.4f}\nIMU×10: {avg_imu_scaled:.6f}\nWeight÷1M: {avg_weight_scaled:.9f}'
+             avg_text = f'Averages:\nPosition: {avg_position:.4f}\nIMU×100: {avg_imu_scaled:.6f}\nWeight÷10K: {avg_weight_scaled:.6f}'
              plt.text(0.98, 0.98, avg_text, transform=plt.gca().transAxes, 
                      verticalalignment='top', horizontalalignment='right',
                      bbox=dict(boxstyle='round', facecolor='lightgreen', alpha=0.8))
          else:
-             plot_title = f'Comparison: Position Error vs IMU Position Residual × 10 - {t_name}'
+             plot_title = f'Comparison: Position Error vs IMU Position Residual × 100 - {t_name}'
              # 只有两条线时的相关性
              correlation_position_imu = np.corrcoef(residual_df['position_error_norm'], imu_residual_norm_scaled)[0,1]
-             plt.text(0.02, 0.98, f'Position-IMU×10 Correlation: {correlation_position_imu:.4f}', 
+             plt.text(0.02, 0.98, f'Position-IMU×100 Correlation: {correlation_position_imu:.4f}', 
                      transform=plt.gca().transAxes, verticalalignment='top', 
                      bbox=dict(boxstyle='round', facecolor='lightcyan', alpha=0.8))
```

```diff
              avg_position = np.mean(residual_df['position_error_norm'])
              avg_imu_scaled = np.mean(imu_residual_norm_scaled)
-             avg_text = f'Averages:\nPosition: {avg_position:.4f}\nIMU×10: {avg_imu_scaled:.6f}'
+             avg_text = f'Averages:\nPosition: {avg_position:.4f}\nIMU×100: {avg_imu_scaled:.6f}'
              plt.text(0.98, 0.98, avg_text, transform=plt.gca().transAxes, 
                      verticalalignment='top', horizontalalignment='right',
```

---

现在我需要更新文件末尾的输出信息，以反映新增的第4.1个子图：

---

```diff
      print("\n=== Analysis Complete ===")
      print("Output files generated:")
-     print("Analysis plots (7 individual plots):")
+     print("Analysis plots (8 individual plots):")
      print("1. R1M1_Proposed_position_error_components.png - Position error components")
      print("2. R1M1_Proposed_imu_pos_res_components.png - IMU position residual components")
      print("3. R1M1_Proposed_norm_comparison.png - Position vs IMU position residual norm comparison")
-     print("4. R1M1_Proposed_scaled_comparison.png - Position error vs IMU position residual × 10 comparison")
-     print("5. R1M1_Proposed_comprehensive_comparison_with_weight.png - Comprehensive comparison with weight ÷ 1,000,000 (if available)")
-     print("6. R1M1_Proposed_raw_vs_weighted_imu_pos.png - Raw vs weighted IMU position residual (if available)")
-     print("7. R1M1_Proposed_imu_pos_res_weight_vs_distance_filtered.png - IMU position residual weight vs travel distance (if available)")
+     print("4. R1M1_Proposed_scaled_comparison.png - Position error vs IMU position residual × 100 comparison")
+     print("5. R1M1_Proposed_scaled_comparison_950m_plus.png - Position error vs IMU position residual × 100 comparison (>950m data only)")
+     print("6. R1M1_Proposed_comprehensive_comparison_with_weight.png - Comprehensive comparison with weight ÷ 10,000 (if available)")
+     print("7. R1M1_Proposed_raw_vs_weighted_imu_pos.png - Raw vs weighted IMU position residual (if available)")
+     print("8. R1M1_Proposed_imu_pos_res_weight_vs_distance_filtered.png - IMU position residual weight vs travel distance (if available)")
      print("Distribution analysis plots (7 individual plots):")
-     print("8. imu_pos_res_norm_distribution.png - IMU position residual norm distribution")
-     print("9. imu_pos_res_x_distribution.png - IMU position residual X component distribution")
-     print("10. imu_pos_res_y_distribution.png - IMU position residual Y component distribution")
-     print("11. imu_pos_res_z_distribution.png - IMU position residual Z component distribution")
-     print("12. position_vs_imu_pos_res_scatter.png - Position vs IMU position residual scatter plot")
-     print("13. imu_pos_res_vs_travel_distance.png - IMU position residual vs travel distance")
-     print("14. raw_vs_weighted_imu_pos_res_scatter.png - Raw vs weighted IMU position residual scatter (if available)")
+     print("9. imu_pos_res_norm_distribution.png - IMU position residual norm distribution")
+     print("10. imu_pos_res_x_distribution.png - IMU position residual X component distribution")
+     print("11. imu_pos_res_y_distribution.png - IMU position residual Y component distribution")
+     print("12. imu_pos_res_z_distribution.png - IMU position residual Z component distribution")
+     print("13. position_vs_imu_pos_res_scatter.png - Position vs IMU position residual scatter plot")
+     print("14. imu_pos_res_vs_travel_distance.png - IMU position residual vs travel distance")
+     print("15. raw_vs_weighted_imu_pos_res_scatter.png - Raw vs weighted IMU position residual scatter (if available)")
      print("Data files:")
-     print("15. R1M1_Proposed_synchronized_imu_pos_res_analysis.csv - Synchronized data")
-     print("16. R1M1_Proposed_imu_pos_res_statistics.csv - Statistical analysis") 
+     print("16. R1M1_Proposed_synchronized_imu_pos_res_analysis.csv - Synchronized data")
+     print("17. R1M1_Proposed_imu_pos_res_statistics.csv - Statistical analysis") 
```

---

完成了！我已经成功地在第四个子图的基础上新增了一个专门分析950m以后数据的子图（第4.1个子图）。

## 新增的第4.1个子图功能：

### **主要特性：**
1. **数据过滤：** 只显示行驶距离 > 950m 的数据点
2. **双曲线显示：**
   - 位置误差范数（蓝色线）
   - IMU位置残差范数×100（红色线）
3. **智能处理：** 如果没有950m以后的数据，会显示"无数据可用"的提示

### **统计信息显示：**
- **数据统计：** 显示950m以后的数据点数量和占总数据的百分比
- **相关性分析：** 计算950m以后数据的位置误差与IMU残差的相关性
- **平均值分析：** 显示950m以后数据的各项指标平均值
- **比例信息：** 计算位置误差与IMU残差的比例关系

### **文件输出：**
- 保存为独立的PNG文件：`R1M1_Proposed_scaled_comparison_950m_plus.png`
- 如果没有数据则保存为：`R1M1_Proposed_no_data_950m_plus.png`

### **分析价值：**
这个新增的子图可以帮助：
1. **后期性能分析：** 观察系统在运行后期（950m以后）的性能表现
2. **稳定性评估：** 分析长距离运行后系统的稳定性
3. **数据对比：** 将后期数据与全程数据进行对比分析
4. **趋势识别：** 识别系统在长时间运行后的特定趋势

现在总共有8个分析子图和7个分布分析子图，文件输出信息也已经相应更新，包括了所有缩放因子的修正（×100而不是×10，权重÷10,000而不是÷1,000,000）。

---

_**User**_

在第4.1个子图基础上新增1个子图，同时显示950m以后的imu残差权重

---

_**Assistant**_



---

我需要在第4.1个子图的基础上新增一个子图，同时显示950m以后的IMU残差权重。让我先查看第4.1个子图的完整代码，然后在其后面添加新的子图。

---

Read file: evaluate/imu_residual/analyzeIMUPositionResidual.py

---

现在我在第4.1个子图之后、第4.5个子图之前，新增一个第4.2个子图，同时显示950m以后的位置误差、IMU残差×10000和IMU残差权重：

---

```diff
          if np.any(mask_950m):
              filtered_df = residual_df[mask_950m]
-             imu_residual_norm_scaled_950 = filtered_df['imu_pos_res_norm'] * 10000  # 放大100倍
+             imu_residual_norm_scaled_950 = filtered_df['imu_pos_res_norm'] * 10000  # 放大10000倍
              
              plt.plot(filtered_df['travel_distance'], filtered_df['position_error_norm'], 
                      label=f"Position Error Norm - {label}", alpha=0.8, linewidth=2, color='blue')
              plt.plot(filtered_df['travel_distance'], imu_residual_norm_scaled_950, 
-                     label=f"IMU Pos Residual Norm × 100 - {label}", alpha=0.8, linewidth=2, color='red')
+                     label=f"IMU Pos Residual Norm × 10000 - {label}", alpha=0.8, linewidth=2, color='red')
              plt.xlabel('Travel Distance (m)')
              plt.ylabel('Error Value (m)')
-             plt.title(f'Scaled Comparison (>950m): Position Error vs IMU Position Residual × 100 - {t_name}')
+             plt.title(f'Scaled Comparison (>950m): Position Error vs IMU Position Residual × 10000 - {t_name}')
              plt.legend()
              plt.grid(True, alpha=0.3)
```

```diff
              percentage_950 = (data_count_950 / total_data_count) * 100
              
-             ratio_text_950 = f'Data >950m: {data_count_950}/{total_data_count} ({percentage_950:.1f}%)\nCorrelation: {correlation_scaled_950:.4f}\nAvg Position: {avg_position_950:.4f}\nAvg IMU×100: {avg_imu_scaled_950:.6f}\nRatio: {avg_position_950/avg_imu_scaled_950:.3f}'
+             ratio_text_950 = f'Data >950m: {data_count_950}/{total_data_count} ({percentage_950:.1f}%)\nCorrelation: {correlation_scaled_950:.4f}\nAvg Position: {avg_position_950:.4f}\nAvg IMU×10000: {avg_imu_scaled_950:.6f}\nRatio: {avg_position_950/avg_imu_scaled_950:.3f}'
              plt.text(0.02, 0.98, ratio_text_950, transform=plt.gca().transAxes, 
                      verticalalignment='top', bbox=dict(boxstyle='round', facecolor='lightcyan', alpha=0.8))
```

```diff
          plt.show()
          
-         # 第4.5个子图：综合对比 - 位置误差、IMU位置残差×100、IMU位置残差权重÷10000
+         # 第4.2个子图：综合对比950m以后的数据 - 位置误差、IMU位置残差×10000、IMU位置残差权重
          plt.figure(figsize=(12, 6))
-         # 始终显示位置误差和IMU位置残差×100
-         imu_residual_norm_scaled = residual_df['imu_pos_res_norm'] * 100  # 放大100倍
-         plt.plot(residual_df['travel_distance'], residual_df['position_error_norm'], 
+         # 过滤950m以后的数据
+         mask_950m = residual_df['travel_distance'] > 950
+         if np.any(mask_950m):
+             filtered_df_950 = residual_df[mask_950m]
+             imu_residual_norm_scaled_950 = filtered_df_950['imu_pos_res_norm'] * 10000  # 放大10000倍
+             
+             # 始终显示位置误差和IMU位置残差×10000
+             plt.plot(filtered_df_950['travel_distance'], filtered_df_950['position_error_norm'], 
                      label=f"Position Error Norm - {label}", alpha=0.8, linewidth=2, color='blue')
-         plt.plot(residual_df['travel_distance'], imu_residual_norm_scaled, 
-                 label=f"IMU Pos Residual Norm × 100 - {label}", alpha=0.8, linewidth=2, color='red')
+             plt.plot(filtered_df_950['travel_distance'], imu_residual_norm_scaled_950, 
+                     label=f"IMU Pos Residual Norm × 10000 - {label}", alpha=0.8, linewidth=2, color='red')
              
-         # 只有在有加权数据时才显示权重÷10000
-         if 'weighted_imu_pos_res_norm' in residual_df.columns:
-             # 计算权重 = 加权误差 / 原始误差，然后缩小10000倍
-             weights = np.divide(residual_df['weighted_imu_pos_res_norm'], residual_df['imu_pos_res_norm'], 
-                               out=np.ones_like(residual_df['imu_pos_res_norm']), 
-                               where=residual_df['imu_pos_res_norm'] != 0)
-             weight_scaled = weights / 10000  # 缩小10000倍
-             plt.plot(residual_df['travel_distance'], weight_scaled, 
-                     label=f"IMU Pos Residual Weight ÷ 10,000 - {label}", alpha=0.8, linewidth=2, color='orange')
-             plot_title = f'Comprehensive Comparison: Position Error vs IMU Residual × 100 vs Weight ÷ 10,000 - {t_name}'
+             # 只有在有加权数据时才显示权重
+             if 'weighted_imu_pos_res_norm' in filtered_df_950.columns:
+                 # 计算权重 = 加权误差 / 原始误差，然后适当缩放以便显示
+                 weights_950 = np.divide(filtered_df_950['weighted_imu_pos_res_norm'], filtered_df_950['imu_pos_res_norm'], 
+                                       out=np.ones_like(filtered_df_950['imu_pos_res_norm']), 
+                                       where=filtered_df_950['imu_pos_res_norm'] != 0)
+                 weight_scaled_950 = weights_950 / 1000  # 缩小1000倍以便在同一图中显示
+                 plt.plot(filtered_df_950['travel_distance'], weight_scaled_950, 
+                         label=f"IMU Pos Residual Weight ÷ 1000 - {label}", alpha=0.8, linewidth=2, color='orange')
+                 plot_title = f'Comprehensive Comparison (>950m): Position Error vs IMU Residual × 10000 vs Weight ÷ 1000 - {t_name}'
                  
-             # 计算相关性
-             correlation_position_imu = np.corrcoef(residual_df['position_error_norm'], imu_residual_norm_scaled)[0,1]
-             correlation_position_weight = np.corrcoef(residual_df['position_error_norm'], weight_scaled)[0,1]
-             correlation_imu_weight = np.corrcoef(imu_residual_norm_scaled, weight_scaled)[0,1]
+                 # 计算相关性（只针对950m以后的数据）
+                 correlation_position_imu_950 = np.corrcoef(filtered_df_950['position_error_norm'], imu_residual_norm_scaled_950)[0,1]
+                 correlation_position_weight_950 = np.corrcoef(filtered_df_950['position_error_norm'], weight_scaled_950)[0,1]
+                 correlation_imu_weight_950 = np.corrcoef(imu_residual_norm_scaled_950, weight_scaled_950)[0,1]
                  
                  # 添加相关性信息
-             corr_text = f'Correlations:\nPos-IMU×100: {correlation_position_imu:.4f}\nPos-Weight÷10K: {correlation_position_weight:.4f}\nIMU×100-Weight÷10K: {correlation_imu_weight:.4f}'
-             plt.text(0.02, 0.98, corr_text, transform=plt.gca().transAxes, 
+                 data_count_950 = len(filtered_df_950)
+                 total_data_count = len(residual_df)
+                 percentage_950 = (data_count_950 / total_data_count) * 100
+                 corr_text_950 = f'Data >950m: {data_count_950}/{total_data_count} ({percentage_950:.1f}%)\nCorrelations:\nPos-IMU×10K: {correlation_position_imu_950:.4f}\nPos-Weight÷1K: {correlation_position_weight_950:.4f}\nIMU×10K-Weight÷1K: {correlation_imu_weight_950:.4f}'
+                 plt.text(0.02, 0.98, corr_text_950, transform=plt.gca().transAxes, 
                          verticalalignment='top', bbox=dict(boxstyle='round', facecolor='lightcyan', alpha=0.8))
                  
                  # 添加平均值信息
-             avg_position = np.mean(residual_df['position_error_norm'])
-             avg_imu_scaled = np.mean(imu_residual_norm_scaled)
-             avg_weight_scaled = np.mean(weight_scaled)
-             avg_text = f'Averages:\nPosition: {avg_position:.4f}\nIMU×100: {avg_imu_scaled:.6f}\nWeight÷10K: {avg_weight_scaled:.6f}'
-             plt.text(0.98, 0.98, avg_text, transform=plt.gca().transAxes, 
+                 avg_position_950 = np.mean(filtered_df_950['position_error_norm'])
+                 avg_imu_scaled_950 = np.mean(imu_residual_norm_scaled_950)
+                 avg_weight_scaled_950 = np.mean(weight_scaled_950)
+                 avg_text_950 = f'Averages (>950m):\nPosition: {avg_position_950:.4f}\nIMU×10K: {avg_imu_scaled_950:.6f}\nWeight÷1K: {avg_weight_scaled_950:.6f}'
+                 plt.text(0.98, 0.98, avg_text_950, transform=plt.gca().transAxes, 
                          verticalalignment='top', horizontalalignment='right',
                          bbox=dict(boxstyle='round', facecolor='lightgreen', alpha=0.8))
              else:
-             plot_title = f'Comparison: Position Error vs IMU Position Residual × 100 - {t_name}'
+                 plot_title = f'Comparison (>950m): Position Error vs IMU Position Residual × 10000 - {t_name}'
                  # 只有两条线时的相关性
-             correlation_position_imu = np.corrcoef(residual_df['position_error_norm'], imu_residual_norm_scaled)[0,1]
-             plt.text(0.02, 0.98, f'Position-IMU×100 Correlation: {correlation_position_imu:.4f}', 
+                 correlation_position_imu_950 = np.corrcoef(filtered_df_950['position_error_norm'], imu_residual_norm_scaled_950)[0,1]
+                 data_count_950 = len(filtered_df_950)
+                 total_data_count = len(residual_df)
+                 percentage_950 = (data_count_950 / total_data_count) * 100
+                 plt.text(0.02, 0.98, f'Data >950m: {data_count_950}/{total_data_count} ({percentage_950:.1f}%)\nPos-IMU×10K Correlation: {correlation_position_imu_950:.4f}', 
                          transform=plt.gca().transAxes, verticalalignment='top', 
                          bbox=dict(boxstyle='round', facecolor='lightcyan', alpha=0.8))
                  
                  # 平均值信息
-             avg_position = np.mean(residual_df['position_error_norm'])
-             avg_imu_scaled = np.mean(imu_residual_norm_scaled)
-             avg_text = f'Averages:\nPosition: {avg_position:.4f}\nIMU×100: {avg_imu_scaled:.6f}'
-             plt.text(0.98, 0.98, avg_text, transform=plt.gca().transAxes, 
+                 avg_position_950 = np.mean(filtered_df_950['position_error_norm'])
+                 avg_imu_scaled_950 = np.mean(imu_residual_norm_scaled_950)
+                 avg_text_950 = f'Averages (>950m):\nPosition: {avg_position_950:.4f}\nIMU×10K: {avg_imu_scaled_950:.6f}'
+                 plt.text(0.98, 0.98, avg_text_950, transform=plt.gca().transAxes, 
                          verticalalignment='top', horizontalalignment='right',
                          bbox=dict(boxstyle='round', facecolor='lightgreen', alpha=0.8))
```

```diff
              
              if save_residual:
-             plt.savefig(f"{t_name}_{label}_comprehensive_comparison_with_weight.png", dpi=300, bbox_inches='tight')
-             print(f"Comprehensive comparison with weight plot saved as {t_name}_{label}_comprehensive_comparison_with_weight.png")
+                 plt.savefig(f"{t_name}_{label}_comprehensive_comparison_950m_plus_with_weight.png", dpi=300, bbox_inches='tight')
+                 print(f"Comprehensive comparison (>950m) with weight plot saved as {t_name}_{label}_comprehensive_comparison_950m_plus_with_weight.png")
+         else:
+             plt.text(0.5, 0.5, 'No Data Available for Travel Distance > 950m', ha='center', va='center', 
+                     transform=plt.gca().transAxes, fontsize=14, color='gray')
+             plt.xlabel('Travel Distance (m)')
+             plt.ylabel('Error Value')
+             plt.title(f'Comprehensive Comparison (>950m): No Data Available - {t_name}')
+             plt.grid(True, alpha=0.3)
+             if save_residual:
+                 plt.savefig(f"{t_name}_{label}_no_data_950m_comprehensive.png", dpi=300, bbox_inches='tight')
+                 print(f"No data >950m comprehensive plot saved as {t_name}_{label}_no_data_950m_comprehensive.png")
          plt.show()
          
```

---

我发现在编辑过程中，原来的第4.5个子图被替换了。我需要重新添加第4.5个子图，让它显示全程数据的综合对比：

---

```diff
                  print(f"No data >950m comprehensive plot saved as {t_name}_{label}_no_data_950m_comprehensive.png")
          plt.show()
+         
+         # 第4.5个子图：综合对比全程数据 - 位置误差、IMU位置残差×100、IMU位置残差权重÷10000
+         plt.figure(figsize=(12, 6))
+         # 始终显示位置误差和IMU位置残差×100
+         imu_residual_norm_scaled = residual_df['imu_pos_res_norm'] * 100  # 放大100倍
+         plt.plot(residual_df['travel_distance'], residual_df['position_error_norm'], 
+                 label=f"Position Error Norm - {label}", alpha=0.8, linewidth=2, color='blue')
+         plt.plot(residual_df['travel_distance'], imu_residual_norm_scaled, 
+                 label=f"IMU Pos Residual Norm × 100 - {label}", alpha=0.8, linewidth=2, color='red')
+         
+         # 只有在有加权数据时才显示权重÷10000
+         if 'weighted_imu_pos_res_norm' in residual_df.columns:
+             # 计算权重 = 加权误差 / 原始误差，然后缩小10000倍
+             weights = np.divide(residual_df['weighted_imu_pos_res_norm'], residual_df['imu_pos_res_norm'], 
+                               out=np.ones_like(residual_df['imu_pos_res_norm']), 
+                               where=residual_df['imu_pos_res_norm'] != 0)
+             weight_scaled = weights / 10000  # 缩小10000倍
+             plt.plot(residual_df['travel_distance'], weight_scaled, 
+                     label=f"IMU Pos Residual Weight ÷ 10,000 - {label}", alpha=0.8, linewidth=2, color='orange')
+             plot_title = f'Comprehensive Comparison: Position Error vs IMU Residual × 100 vs Weight ÷ 10,000 - {t_name}'
+             
+             # 计算相关性
+             correlation_position_imu = np.corrcoef(residual_df['position_error_norm'], imu_residual_norm_scaled)[0,1]
+             correlation_position_weight = np.corrcoef(residual_df['position_error_norm'], weight_scaled)[0,1]
+             correlation_imu_weight = np.corrcoef(imu_residual_norm_scaled, weight_scaled)[0,1]
+             
+             # 添加相关性信息
+             corr_text = f'Correlations:\nPos-IMU×100: {correlation_position_imu:.4f}\nPos-Weight÷10K: {correlation_position_weight:.4f}\nIMU×100-Weight÷10K: {correlation_imu_weight:.4f}'
+             plt.text(0.02, 0.98, corr_text, transform=plt.gca().transAxes, 
+                     verticalalignment='top', bbox=dict(boxstyle='round', facecolor='lightcyan', alpha=0.8))
+             
+             # 添加平均值信息
+             avg_position = np.mean(residual_df['position_error_norm'])
+             avg_imu_scaled = np.mean(imu_residual_norm_scaled)
+             avg_weight_scaled = np.mean(weight_scaled)
+             avg_text = f'Averages:\nPosition: {avg_position:.4f}\nIMU×100: {avg_imu_scaled:.6f}\nWeight÷10K: {avg_weight_scaled:.6f}'
+             plt.text(0.98, 0.98, avg_text, transform=plt.gca().transAxes, 
+                     verticalalignment='top', horizontalalignment='right',
+                     bbox=dict(boxstyle='round', facecolor='lightgreen', alpha=0.8))
+         else:
+             plot_title = f'Comparison: Position Error vs IMU Position Residual × 100 - {t_name}'
+             # 只有两条线时的相关性
+             correlation_position_imu = np.corrcoef(residual_df['position_error_norm'], imu_residual_norm_scaled)[0,1]
+             plt.text(0.02, 0.98, f'Position-IMU×100 Correlation: {correlation_position_imu:.4f}', 
+                     transform=plt.gca().transAxes, verticalalignment='top', 
+                     bbox=dict(boxstyle='round', facecolor='lightcyan', alpha=0.8))
+             
+             # 平均值信息
+             avg_position = np.mean(residual_df['position_error_norm'])
+             avg_imu_scaled = np.mean(imu_residual_norm_scaled)
+             avg_text = f'Averages:\nPosition: {avg_position:.4f}\nIMU×100: {avg_imu_scaled:.6f}'
+             plt.text(0.98, 0.98, avg_text, transform=plt.gca().transAxes, 
+                     verticalalignment='top', horizontalalignment='right',
+                     bbox=dict(boxstyle='round', facecolor='lightgreen', alpha=0.8))
+         
+         plt.xlabel('Travel Distance (m)')
+         plt.ylabel('Error Value')
+         plt.title(plot_title)
+         plt.legend(bbox_to_anchor=(0.5, 1.15), loc='upper center', ncol=2)
+         plt.grid(True, alpha=0.3)
+         
+         if save_residual:
+             plt.savefig(f"{t_name}_{label}_comprehensive_comparison_with_weight.png", dpi=300, bbox_inches='tight')
+             print(f"Comprehensive comparison with weight plot saved as {t_name}_{label}_comprehensive_comparison_with_weight.png")
+         plt.show()
          
          # 第五个子图：如果有加权IMU位置残差，则对比原始和加权
```

---

现在我需要更新文件末尾的输出信息，以反映新增的第4.2个子图：

---

```diff
      print("\n=== Analysis Complete ===")
      print("Output files generated:")
-     print("Analysis plots (8 individual plots):")
+     print("Analysis plots (9 individual plots):")
      print("1. R1M1_Proposed_position_error_components.png - Position error components")
      print("2. R1M1_Proposed_imu_pos_res_components.png - IMU position residual components")
      print("3. R1M1_Proposed_norm_comparison.png - Position vs IMU position residual norm comparison")
      print("4. R1M1_Proposed_scaled_comparison.png - Position error vs IMU position residual × 100 comparison")
-     print("5. R1M1_Proposed_scaled_comparison_950m_plus.png - Position error vs IMU position residual × 100 comparison (>950m data only)")
-     print("6. R1M1_Proposed_comprehensive_comparison_with_weight.png - Comprehensive comparison with weight ÷ 10,000 (if available)")
-     print("7. R1M1_Proposed_raw_vs_weighted_imu_pos.png - Raw vs weighted IMU position residual (if available)")
-     print("8. R1M1_Proposed_imu_pos_res_weight_vs_distance_filtered.png - IMU position residual weight vs travel distance (if available)")
+     print("5. R1M1_Proposed_scaled_comparison_950m_plus.png - Position error vs IMU position residual × 10000 comparison (>950m data only)")
+     print("6. R1M1_Proposed_comprehensive_comparison_950m_plus_with_weight.png - Comprehensive comparison with weight ÷ 1000 (>950m data only, if available)")
+     print("7. R1M1_Proposed_comprehensive_comparison_with_weight.png - Comprehensive comparison with weight ÷ 10,000 (full data, if available)")
+     print("8. R1M1_Proposed_raw_vs_weighted_imu_pos.png - Raw vs weighted IMU position residual (if available)")
+     print("9. R1M1_Proposed_imu_pos_res_weight_vs_distance_filtered.png - IMU position residual weight vs travel distance (if available)")
      print("Distribution analysis plots (7 individual plots):")
-     print("9. imu_pos_res_norm_distribution.png - IMU position residual norm distribution")
-     print("10. imu_pos_res_x_distribution.png - IMU position residual X component distribution")
-     print("11. imu_pos_res_y_distribution.png - IMU position residual Y component distribution")
-     print("12. imu_pos_res_z_distribution.png - IMU position residual Z component distribution")
-     print("13. position_vs_imu_pos_res_scatter.png - Position vs IMU position residual scatter plot")
-     print("14. imu_pos_res_vs_travel_distance.png - IMU position residual vs travel distance")
-     print("15. raw_vs_weighted_imu_pos_res_scatter.png - Raw vs weighted IMU position residual scatter (if available)")
+     print("10. imu_pos_res_norm_distribution.png - IMU position residual norm distribution")
+     print("11. imu_pos_res_x_distribution.png - IMU position residual X component distribution")
+     print("12. imu_pos_res_y_distribution.png - IMU position residual Y component distribution")
+     print("13. imu_pos_res_z_distribution.png - IMU position residual Z component distribution")
+     print("14. position_vs_imu_pos_res_scatter.png - Position vs IMU position residual scatter plot")
+     print("15. imu_pos_res_vs_travel_distance.png - IMU position residual vs travel distance")
+     print("16. raw_vs_weighted_imu_pos_res_scatter.png - Raw vs weighted IMU position residual scatter (if available)")
      print("Data files:")
-     print("16. R1M1_Proposed_synchronized_imu_pos_res_analysis.csv - Synchronized data")
-     print("17. R1M1_Proposed_imu_pos_res_statistics.csv - Statistical analysis") 
+     print("17. R1M1_Proposed_synchronized_imu_pos_res_analysis.csv - Synchronized data")
+     print("18. R1M1_Proposed_imu_pos_res_statistics.csv - Statistical analysis") 
```

---

完成了！我已经成功地在第4.1个子图基础上新增了第4.2个子图，同时显示950m以后的IMU残差权重。

## 新增的第4.2个子图功能总结：

### **主要特性：**
1. **数据过滤：** 只分析行驶距离 > 950m 的数据
2. **三条曲线同时显示：**
   - **位置误差范数**（蓝色线）
   - **IMU位置残差范数×10000**（红色线）
   - **IMU位置残差权重÷1000**（橙色线，只有在存在加权数据时显示）

### **智能数据处理：**
- 如果没有950m以后的数据，显示"无数据可用"的提示
- 权重缩放为÷1000，以便在同一图表中与其他数据进行对比
- 只有在存在加权数据时才显示第三条线

### **统计信息显示：**
1. **数据统计：** 显示950m以后数据点数量和占总数据的百分比
2. **三重相关性分析：**
   - 位置误差 vs IMU残差×10000
   - 位置误差 vs 权重÷1000
   - IMU残差×10000 vs 权重÷1000
3. **平均值分析：** 显示950m以后三种指标的平均值

### **文件输出：**
- 有数据时保存为：`R1M1_Proposed_comprehensive_comparison_950m_plus_with_weight.png`
- 无数据时保存为：`R1M1_Proposed_no_data_950m_comprehensive.png`

### **分析价值：**
这个新增的子图可以帮助：
1. **后期综合性能分析：** 同时观察系统在950m以后的位置误差、IMU残差和权重变化
2. **多指标关联分析：** 理解三个关键指标之间的相互关系
3. **长距离稳定性评估：** 评估系统在长距离运行后的综合表现
4. **权重效果验证：** 观察权重调整在后期数据中的效果

现在总共有9个分析子图和7个分布分析子图，完整的分析流程包括：
- 全程数据分析（4个基础子图）
- 950m后数据专门分析（2个子图）
- 全程数据综合分析（1个子图）
- 原始vs加权对比（1个子图）
- 权重变化分析（1个子图）

---

_**User**_

第4.5个子图基础上新增一个子图，去除位置误差

---

_**Assistant**_



---

我需要在第4.5个子图的基础上新增一个子图，去除位置误差，只显示IMU位置残差和权重。让我先查看第4.5个子图的完整代码，然后添加新的子图。

---

Read file: evaluate/imu_residual/analyzeIMUPositionResidual.py

---

现在我在第4.5个子图之后添加第4.6个子图，去除位置误差，只显示IMU位置残差×100和权重÷10000：

---

```diff
              print(f"Comprehensive comparison with weight plot saved as {t_name}_{label}_comprehensive_comparison_with_weight.png")
          plt.show()
+         
+         # 第4.6个子图：IMU位置残差×100与权重÷10000对比（去除位置误差）
+         plt.figure(figsize=(10, 6))
+         # 显示IMU位置残差×100
+         imu_residual_norm_scaled = residual_df['imu_pos_res_norm'] * 100  # 放大100倍
+         plt.plot(residual_df['travel_distance'], imu_residual_norm_scaled, 
+                 label=f"IMU Pos Residual Norm × 100 - {label}", alpha=0.8, linewidth=2, color='red')
+         
+         # 只有在有加权数据时才显示权重÷10000
+         if 'weighted_imu_pos_res_norm' in residual_df.columns:
+             # 计算权重 = 加权误差 / 原始误差，然后缩小10000倍
+             weights = np.divide(residual_df['weighted_imu_pos_res_norm'], residual_df['imu_pos_res_norm'], 
+                               out=np.ones_like(residual_df['imu_pos_res_norm']), 
+                               where=residual_df['imu_pos_res_norm'] != 0)
+             weight_scaled = weights / 10000  # 缩小10000倍
+             plt.plot(residual_df['travel_distance'], weight_scaled, 
+                     label=f"IMU Pos Residual Weight ÷ 10,000 - {label}", alpha=0.8, linewidth=2, color='orange')
+             plot_title = f'IMU Residual × 100 vs Weight ÷ 10,000 - {t_name}'
+             
+             # 计算相关性（只有IMU残差和权重）
+             correlation_imu_weight = np.corrcoef(imu_residual_norm_scaled, weight_scaled)[0,1]
+             
+             # 添加相关性信息
+             corr_text = f'IMU×100-Weight÷10K Correlation: {correlation_imu_weight:.4f}'
+             plt.text(0.02, 0.98, corr_text, transform=plt.gca().transAxes, 
+                     verticalalignment='top', bbox=dict(boxstyle='round', facecolor='lightcyan', alpha=0.8))
+             
+             # 添加平均值信息
+             avg_imu_scaled = np.mean(imu_residual_norm_scaled)
+             avg_weight_scaled = np.mean(weight_scaled)
+             avg_text = f'Averages:\nIMU×100: {avg_imu_scaled:.6f}\nWeight÷10K: {avg_weight_scaled:.6f}\nRatio (IMU/Weight): {avg_imu_scaled/avg_weight_scaled:.2f}'
+             plt.text(0.98, 0.98, avg_text, transform=plt.gca().transAxes, 
+                     verticalalignment='top', horizontalalignment='right',
+                     bbox=dict(boxstyle='round', facecolor='lightgreen', alpha=0.8))
+         else:
+             plot_title = f'IMU Position Residual × 100 - {t_name}'
+             # 只有一条线时的统计信息
+             avg_imu_scaled = np.mean(imu_residual_norm_scaled)
+             std_imu_scaled = np.std(imu_residual_norm_scaled)
+             max_imu_scaled = np.max(imu_residual_norm_scaled)
+             min_imu_scaled = np.min(imu_residual_norm_scaled)
+             stats_text = f'IMU×100 Statistics:\nMean: {avg_imu_scaled:.6f}\nStd: {std_imu_scaled:.6f}\nMax: {max_imu_scaled:.6f}\nMin: {min_imu_scaled:.6f}'
+             plt.text(0.02, 0.98, stats_text, transform=plt.gca().transAxes, 
+                     verticalalignment='top', bbox=dict(boxstyle='round', facecolor='lightcyan', alpha=0.8))
+         
+         plt.xlabel('Travel Distance (m)')
+         plt.ylabel('Scaled Value')
+         plt.title(plot_title)
+         plt.legend()
+         plt.grid(True, alpha=0.3)
+         
+         if save_residual:
+             plt.savefig(f"{t_name}_{label}_imu_residual_vs_weight_only.png", dpi=300, bbox_inches='tight')
+             print(f"IMU residual vs weight only plot saved as {t_name}_{label}_imu_residual_vs_weight_only.png")
+         plt.show()
          
          # 第五个子图：如果有加权IMU位置残差，则对比原始和加权
```

---

现在我需要更新文件末尾的输出信息，以反映新增的第4.6个子图：

---

```diff
      print("\n=== Analysis Complete ===")
      print("Output files generated:")
-     print("Analysis plots (9 individual plots):")
+     print("Analysis plots (10 individual plots):")
      print("1. R1M1_Proposed_position_error_components.png - Position error components")
      print("2. R1M1_Proposed_imu_pos_res_components.png - IMU position residual components")
      print("3. R1M1_Proposed_norm_comparison.png - Position vs IMU position residual norm comparison")
      print("4. R1M1_Proposed_scaled_comparison.png - Position error vs IMU position residual × 100 comparison")
      print("5. R1M1_Proposed_scaled_comparison_950m_plus.png - Position error vs IMU position residual × 10000 comparison (>950m data only)")
-     print("6. R1M1_Proposed_comprehensive_comparison_950m_plus_with_weight.png - Comprehensive comparison with weight ÷ 1000 (>950m data only, if available)")
+     print("6. R1M1_Proposed_comprehensive_comparison_950m_plus_with_weight.png - Comprehensive comparison with weight ÷ 1000000 (>950m data only, if available)")
      print("7. R1M1_Proposed_comprehensive_comparison_with_weight.png - Comprehensive comparison with weight ÷ 10,000 (full data, if available)")
-     print("8. R1M1_Proposed_raw_vs_weighted_imu_pos.png - Raw vs weighted IMU position residual (if available)")
-     print("9. R1M1_Proposed_imu_pos_res_weight_vs_distance_filtered.png - IMU position residual weight vs travel distance (if available)")
+     print("8. R1M1_Proposed_imu_residual_vs_weight_only.png - IMU residual × 100 vs weight ÷ 10,000 only (no position error, if available)")
+     print("9. R1M1_Proposed_raw_vs_weighted_imu_pos.png - Raw vs weighted IMU position residual (if available)")
+     print("10. R1M1_Proposed_imu_pos_res_weight_vs_distance_filtered.png - IMU position residual weight vs travel distance (if available)")
      print("Distribution analysis plots (7 individual plots):")
-     print("10. imu_pos_res_norm_distribution.png - IMU position residual norm distribution")
-     print("11. imu_pos_res_x_distribution.png - IMU position residual X component distribution")
-     print("12. imu_pos_res_y_distribution.png - IMU position residual Y component distribution")
-     print("13. imu_pos_res_z_distribution.png - IMU position residual Z component distribution")
-     print("14. position_vs_imu_pos_res_scatter.png - Position vs IMU position residual scatter plot")
-     print("15. imu_pos_res_vs_travel_distance.png - IMU position residual vs travel distance")
-     print("16. raw_vs_weighted_imu_pos_res_scatter.png - Raw vs weighted IMU position residual scatter (if available)")
+     print("11. imu_pos_res_norm_distribution.png - IMU position residual norm distribution")
+     print("12. imu_pos_res_x_distribution.png - IMU position residual X component distribution")
+     print("13. imu_pos_res_y_distribution.png - IMU position residual Y component distribution")
+     print("14. imu_pos_res_z_distribution.png - IMU position residual Z component distribution")
+     print("15. position_vs_imu_pos_res_scatter.png - Position vs IMU position residual scatter plot")
+     print("16. imu_pos_res_vs_travel_distance.png - IMU position residual vs travel distance")
+     print("17. raw_vs_weighted_imu_pos_res_scatter.png - Raw vs weighted IMU position residual scatter (if available)")
      print("Data files:")
-     print("17. R1M1_Proposed_synchronized_imu_pos_res_analysis.csv - Synchronized data")
-     print("18. R1M1_Proposed_imu_pos_res_statistics.csv - Statistical analysis") 
+     print("18. R1M1_Proposed_synchronized_imu_pos_res_analysis.csv - Synchronized data")
+     print("19. R1M1_Proposed_imu_pos_res_statistics.csv - Statistical analysis") 
```

---

_**User**_

在第四个子图基础上新增一个子图，去除imu位置残差大于0.00005的残差

---

_**Assistant**_



---

我需要在第四个子图的基础上新增一个子图，过滤掉IMU位置残差大于0.00005的数据点。让我先查看第四个子图的完整代码，然后添加新的子图。

---

Read file: evaluate/imu_residual/analyzeIMUPositionResidual.py

---

现在我在第四个子图之后、第4.1个子图之前，新增一个第4.05个子图，过滤掉IMU位置残差大于0.00005的数据点：

---

```diff
              print(f"Scaled comparison plot saved as {t_name}_{label}_scaled_comparison.png")
          plt.show()
+         
+         # 第4.05个子图：IMU位置残差放大100倍和位置误差的对比（过滤IMU位置残差>0.00005）
+         plt.figure(figsize=(10, 6))
+         # 过滤IMU位置残差大于0.00005的数据
+         imu_residual_threshold_filter = 0.00005
+         mask_imu_filter = residual_df['imu_pos_res_norm'] <= imu_residual_threshold_filter
+         if np.any(mask_imu_filter):
+             filtered_df_imu = residual_df[mask_imu_filter]
+             imu_residual_norm_scaled_filtered = filtered_df_imu['imu_pos_res_norm'] * 100  # 放大100倍
+             
+             plt.plot(filtered_df_imu['travel_distance'], filtered_df_imu['position_error_norm'], 
+                     label=f"Position Error Norm - {label}", alpha=0.8, linewidth=2, color='blue')
+             plt.plot(filtered_df_imu['travel_distance'], imu_residual_norm_scaled_filtered, 
+                     label=f"IMU Pos Residual Norm × 100 - {label}", alpha=0.8, linewidth=2, color='red')
+             plt.xlabel('Travel Distance (m)')
+             plt.ylabel('Error Value (m)')
+             plt.title(f'Scaled Comparison (IMU Res ≤{imu_residual_threshold_filter:.5f}): Position Error vs IMU Position Residual × 100 - {t_name}')
+             plt.legend()
+             plt.grid(True, alpha=0.3)
+             
+             # 添加相关性信息到图中（只针对过滤后的数据）
+             correlation_scaled_filtered = np.corrcoef(filtered_df_imu['position_error_norm'], imu_residual_norm_scaled_filtered)[0,1]
+             # 计算比例信息
+             avg_position_filtered = np.mean(filtered_df_imu['position_error_norm'])
+             avg_imu_scaled_filtered = np.mean(imu_residual_norm_scaled_filtered)
+             data_count_filtered = len(filtered_df_imu)
+             total_data_count = len(residual_df)
+             percentage_filtered = (data_count_filtered / total_data_count) * 100
+             filtered_out_count = total_data_count - data_count_filtered
+             
+             ratio_text_filtered = f'Data (IMU≤{imu_residual_threshold_filter:.5f}): {data_count_filtered}/{total_data_count} ({percentage_filtered:.1f}%)\nFiltered out: {filtered_out_count} ({100-percentage_filtered:.1f}%)\nCorrelation: {correlation_scaled_filtered:.4f}\nAvg Position: {avg_position_filtered:.4f}\nAvg IMU×100: {avg_imu_scaled_filtered:.6f}\nRatio: {avg_position_filtered/avg_imu_scaled_filtered:.3f}'
+             plt.text(0.02, 0.98, ratio_text_filtered, transform=plt.gca().transAxes, 
+                     verticalalignment='top', bbox=dict(boxstyle='round', facecolor='lightcyan', alpha=0.8))
+             
+             if save_residual:
+                 plt.savefig(f"{t_name}_{label}_scaled_comparison_imu_filtered.png", dpi=300, bbox_inches='tight')
+                 print(f"Scaled comparison (IMU filtered ≤{imu_residual_threshold_filter:.5f}) plot saved as {t_name}_{label}_scaled_comparison_imu_filtered.png")
+         else:
+             plt.text(0.5, 0.5, f'No Data Available for IMU Position Residual ≤ {imu_residual_threshold_filter:.5f}', ha='center', va='center', 
+                     transform=plt.gca().transAxes, fontsize=14, color='gray')
+             plt.xlabel('Travel Distance (m)')
+             plt.ylabel('Error Value (m)')
+             plt.title(f'Scaled Comparison (IMU Res ≤{imu_residual_threshold_filter:.5f}): No Data Available - {t_name}')
+             plt.grid(True, alpha=0.3)
+             if save_residual:
+                 plt.savefig(f"{t_name}_{label}_no_data_imu_filtered.png", dpi=300, bbox_inches='tight')
+                 print(f"No data (IMU filtered) plot saved as {t_name}_{label}_no_data_imu_filtered.png")
+         plt.show()
          
          # 第4.1个子图：IMU位置残差放大100倍和位置误差的对比（只分析950m以后的数据）
```

---

现在我需要更新文件末尾的输出信息，以反映新增的第4.05个子图：

---

```diff
      print("\n=== Analysis Complete ===")
      print("Output files generated:")
-     print("Analysis plots (10 individual plots):")
+     print("Analysis plots (11 individual plots):")
      print("1. R1M1_Proposed_position_error_components.png - Position error components")
      print("2. R1M1_Proposed_imu_pos_res_components.png - IMU position residual components")
      print("3. R1M1_Proposed_norm_comparison.png - Position vs IMU position residual norm comparison")
      print("4. R1M1_Proposed_scaled_comparison.png - Position error vs IMU position residual × 100 comparison")
-     print("5. R1M1_Proposed_scaled_comparison_950m_plus.png - Position error vs IMU position residual × 10000 comparison (>950m data only)")
-     print("6. R1M1_Proposed_comprehensive_comparison_950m_plus_with_weight.png - Comprehensive comparison with weight ÷ 1000000 (>950m data only, if available)")
-     print("7. R1M1_Proposed_comprehensive_comparison_with_weight.png - Comprehensive comparison with weight ÷ 10,000 (full data, if available)")
-     print("8. R1M1_Proposed_imu_residual_vs_weight_only.png - IMU residual × 100 vs weight ÷ 10,000 only (no position error, if available)")
-     print("9. R1M1_Proposed_raw_vs_weighted_imu_pos.png - Raw vs weighted IMU position residual (if available)")
-     print("10. R1M1_Proposed_imu_pos_res_weight_vs_distance_filtered.png - IMU position residual weight vs travel distance (if available)")
+     print("5. R1M1_Proposed_scaled_comparison_imu_filtered.png - Position error vs IMU position residual × 100 comparison (IMU residual ≤0.00005 only)")
+     print("6. R1M1_Proposed_scaled_comparison_950m_plus.png - Position error vs IMU position residual × 10000 comparison (>950m data only)")
+     print("7. R1M1_Proposed_comprehensive_comparison_950m_plus_with_weight.png - Comprehensive comparison with weight ÷ 1000000 (>950m data only, if available)")
+     print("8. R1M1_Proposed_comprehensive_comparison_with_weight.png - Comprehensive comparison with weight ÷ 10,000 (full data, if available)")
+     print("9. R1M1_Proposed_imu_residual_vs_weight_only.png - IMU residual vs weight ÷ 100000000 only (no position error, if available)")
+     print("10. R1M1_Proposed_raw_vs_weighted_imu_pos.png - Raw vs weighted IMU position residual (if available)")
+     print("11. R1M1_Proposed_imu_pos_res_weight_vs_distance_filtered.png - IMU position residual weight vs travel distance (if available)")
      print("Distribution analysis plots (7 individual plots):")
-     print("11. imu_pos_res_norm_distribution.png - IMU position residual norm distribution")
-     print("12. imu_pos_res_x_distribution.png - IMU position residual X component distribution")
-     print("13. imu_pos_res_y_distribution.png - IMU position residual Y component distribution")
-     print("14. imu_pos_res_z_distribution.png - IMU position residual Z component distribution")
-     print("15. position_vs_imu_pos_res_scatter.png - Position vs IMU position residual scatter plot")
-     print("16. imu_pos_res_vs_travel_distance.png - IMU position residual vs travel distance")
-     print("17. raw_vs_weighted_imu_pos_res_scatter.png - Raw vs weighted IMU position residual scatter (if available)")
+     print("12. imu_pos_res_norm_distribution.png - IMU position residual norm distribution")
+     print("13. imu_pos_res_x_distribution.png - IMU position residual X component distribution")
+     print("14. imu_pos_res_y_distribution.png - IMU position residual Y component distribution")
+     print("15. imu_pos_res_z_distribution.png - IMU position residual Z component distribution")
+     print("16. position_vs_imu_pos_res_scatter.png - Position vs IMU position residual scatter plot")
+     print("17. imu_pos_res_vs_travel_distance.png - IMU position residual vs travel distance")
+     print("18. raw_vs_weighted_imu_pos_res_scatter.png - Raw vs weighted IMU position residual scatter (if available)")
      print("Data files:")
-     print("18. R1M1_Proposed_synchronized_imu_pos_res_analysis.csv - Synchronized data")
-     print("19. R1M1_Proposed_imu_pos_res_statistics.csv - Statistical analysis") 
+     print("19. R1M1_Proposed_synchronized_imu_pos_res_analysis.csv - Synchronized data")
+     print("20. R1M1_Proposed_imu_pos_res_statistics.csv - Statistical analysis") 
```

---

完成了！我已经成功地在第四个子图的基础上新增了第4.05个子图，该子图会过滤掉IMU位置残差大于0.00005的数据点。

## 新增的第4.05个子图功能总结：

### **主要特性：**
1. **数据过滤：** 只显示IMU位置残差 ≤ 0.00005 的数据点
2. **双曲线显示：**
   - **位置误差范数**（蓝色线）
   - **IMU位置残差范数×100**（红色线）
3. **智能处理：** 如果没有满足条件的数据，显示"无数据可用"的提示

### **详细统计信息显示：**
1. **数据统计：**
   - 显示满足条件的数据点数量和占总数据的百分比
   - 显示被过滤掉的数据点数量和百分比
2. **相关性分析：** 计算过滤后数据的位置误差与IMU残差的相关性
3. **平均值分析：** 显示过滤后数据的各项指标平均值
4. **比例关系：** 计算位置误差与IMU残差的比例关系

### **文件输出：**
- 有数据时保存为：`R1M1_Proposed_scaled_comparison_imu_filtered.png`
- 无数据时保存为：`R1M1_Proposed_no_data_imu_filtered.png`

### **分析价值：**
这个新增的子图可以帮助：
1. **高质量数据分析：** 专门分析IMU残差较小（≤0.00005）的高质量数据段
2. **异常值过滤：** 排除可能的异常或噪声数据，观察系统的稳定性能
3. **精度评估：** 在IMU残差较小的情况下，评估位置误差的表现
4. **数据质量监控：** 了解有多少数据点的IMU残差超过了0.00005的阈值
5. **相关性验证：** 在去除异常值后，验证位置误差与IMU残差的真实相关性

### **输出信息更新：**
- 总分析子图数量从10个增加到11个
- 新增第5个分析子图专门显示过滤后的数据
- 更新了第9个子图的描述，反映了权重缩放因子的变化（÷100000000）

现在总共有11个分析子图和7个分布分析子图，提供了全面的IMU位置残差分析功能，包括原始数据、过滤数据、特定距离段数据和综合对比等多个维度的分析。

---

